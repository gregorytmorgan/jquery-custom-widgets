<!DOCTYPE html>
<!--
jQuery Timeline-control Widget
-->
<html>
  <head>
    <title>jQuery Custom Widget Tests</title>
    <link rel="icon" href="favicon.ico" sizes="16x16 32x32 48x48 64x64 96x96 128x128" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="css/index.css">
    <link rel="stylesheet" type="text/css" href="css/timeline-control.css">
    <link rel="stylesheet" type="text/css" href="css/barView.css">
    <link rel="stylesheet" type="text/css" href="css/barViewConstraint.css">

    <script src="vendor/jquery.js"></script>
    <script src="vendor/jquery-ui.js"></script>
    <script src="vendor/d3.js"></script>
    <script src="js/timeline.js"></script>
    <script src="js/barView.js"></script>
    <script src="js/barViewConstraint.js"></script>
    <script>

      const MIN_DATA_VALUE = 10;
      const MAX_DATA_VALUE = 1000;

      let testDataN = [];

      /**
       * Create a random data set with a size of 'sz' and values between 'min' and 'max'.
       *
       * sz {integer} Number of values
       * range {object} Range of values, {"min":int, "max": int}
       */
      function makeRandomDataSet(sz, range) {
        let i, data = [];

        for (i = 0; i < sz; i +=1) {
          data[i] = {
            'key': Math.round(Math.random() * (range.max - range.min) + range.min),
            'value': i
          };
        }

        return data;
      }

      // An empty data set is an error/invalid
      let testData0 = [];

      let testData1 = [
        {'key':-1, 'value': 1}
      ];

      let testData2 = [
        {'key':0, 'value': 0},
        {'key':1, 'value': 1}
      ];

      let testData3 = [
        {'key':0, 'value': 0},
        [
          {'key':1, 'value': 1},
          {'key':1, 'value': 2}
        ]
      ];

      let testData5 = [
        {'key':1, 'value': 1},
        {'key':2, 'value': 2},
        {'key':3, 'value': 3},
        {'key':4, 'value': 4},
        {'key':5, 'value': 5}
      ]

      let testData10 = [
        {'key':1, 'value': 1},
        {'key':2, 'value': 2},
        {'key':3, 'value': 3},
        {'key':3, 'value': 4},
        {'key':9, 'value': 5},
        {'key':8, 'value': 6},
        {'key':7, 'value': 7},
        {'key':6, 'value': 8},
        {'key':5, 'value': 9},
        {'key':3, 'value': 10}
      ]

      let dataSets =[
        testData0,
        testData1,
        testData2,
        testData3,
        testData5,
        testData10
      ]

      /*
       * On load handler
       *
       * @returns {undefined}
       */
      window.onload = function () {
        console.log("OnLoad");
      };

      /*
       * Document ready handler
       *
       * @type type
       */
      $(document).ready(function () {
        console.log("documentReady");

        //
        // setup the data contraint view
        //

        // alternate widget initialization syntax
        // var bar = $.custom.progressbar({}, $("<div></div>").appendTo("body"));

//        let widgetElement1 = $("#widgetElement1");
//
//        // construct a timeline widget in the widgetElement2 element. We pass
//        // in a custom handler for the atstart' custom event.
//        widgetElement1.timeline({
//          // the widget defaults to using the widgetElement height, which is not set,
//          // so provide an explict height.
//          height: '50px',
//          data: testData10
//        });
//
//        // Alternate way of calling widget methods by calling object and passing in func name
//        //console.log("Initial value: " + widgetElement.timeline("value"));
//
//        let dataConstraint = widgetElement1.data("custom-timeline");
//
//        // Example of adding an additional event hander vs overriding the default.
//        //
//        // Notes:
//        // 1) Custom handlers are called before the default.
//        // 2) Returning false or using stopImmediatePropagation(), stopPropagation()
//        // and preventDefault() does not seem to stop the default handler from firing?
//        // 3) Context can be pass either by EMCMA5 'bind' or using jquery proxy().
//        widgetElement1.on("timelinechange", (function (event, data) {
//          console.log(this.widgetName + ".change - User defined chained handler. Key: '" + data.key  + "', Value: " + data.value);
//        }).bind(dataConstraint));




        //
        // setup the primary data view
        //

        let widgetElement2 = $("#widgetElement2");

        widgetElement2.barView({
//          height: '48px',
//          data: testData10,
//          "change": function (event, data) {
//            console.log(this.widgetName + '.change - #1 key: ' + data.key + ", old:" + data.oldValue + ", new:" + data.value);
//          }
        });

        let myBarView = widgetElement2.data("custom-barView");

        myBarView.option('height', '120px');

        // update the change handler
        myBarView.option('change', function (event, data)  {
            console.log(this.widgetName + '.change - #2 key: ' + data.key + ", old:" + data.oldValue + ", new:" + data.value);
          });

        // confirm change handler update + test auto redraw(?)
        myBarView.option('cloneData', true);
        myBarView.option('cloneData', true);
        myBarView.option('cloneData', false);

        myBarView.option('create', function (evt, data) { alert('hi'); });
        myBarView.option('create', function (evt, data) { alert('hello'); });
        myBarView.option('create', function (evt, data) { alert('hello'); });

        //
        // setup the primary data view constraint
        //

//        let widgetElement3 = $("#widgetElement3");
//
//        widgetElement3.barViewConstraint({
//          'height': '48px',
//          'data': testData10,
//          'afterWindowMove': function (event, data) {
//            let selectValue, size, testData, newTestData, left, right;
//
//            testData = data.context.option('data');
//
//            left = Math.floor(data.context.windowStart() * testData.length),
//            right = Math.ceil(data.context.windowEnd() * testData.length);
//
//            newTestData = testData.splice(left, right);
//
//            myBarView.option('data', newTestData);
//          }
//        });
//
//        let myBarViewConstraint = widgetElement3.data("custom-barViewConstraint");

        //
        // Setup the load data UI
        //
        // Note: the click event also triggers on 'keypress enter'
        //
        $('#bGo').on('click', function (event) {
          let idx, testData, size,
            selectValue = $('#dataSet').val();

          if (selectValue === "N") {
            size = Math.round(Math.random() * (100 - 10) + 10);
            testData = makeRandomDataSet(size, {"min":MIN_DATA_VALUE, "max":MAX_DATA_VALUE});
          } else {
            idx = parseInt(selectValue);
            testData = dataSets[idx];
          }

//          try {
//            dataConstraint.option('data', testData);
//          } catch (e) {
//            alert (e.message);
//          }

          try {
            myBarView.option('data', testData);
          } catch (e) {
            alert (e.message);
          }

//          try {
//            myBarViewConstraint.option('data', testData);
//          } catch (e) {
//            alert (e.message);
//          }

        });

      });

  </script>
  </head>
  <body>
    <div class="content">
      <div class="title-block">
        <h1>Timeline Control Widget Test</h1>
      </div>

      <div id="widgetElement1" class="widgetElement full"></div>
      <div id="widgetElement2" class="widgetElement full"></div>
      <div id="widgetElement3" class="widgetElement full"></div>

      <div class="test-selector-container">
        <select id="dataSet">
          <option value="0">Test Data #0</option>
          <option value="1">Test Data #1</option>
          <option value="2">Test Data #2</option>
          <option value="3">Test Data #3</option>
          <option value="4">Test Data #5</option>
          <option value="5" selected>Test Data #10</option>
          <option value="N">Test Data #N</option>
        </select>
        <button id="bGo">Load Data</button>
      </div>
    </div><!-- content -->

    <div id="debugConsole"></div>

  </body>
</html>
