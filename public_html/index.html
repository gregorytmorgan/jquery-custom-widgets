<!DOCTYPE html>
<!--
jQuery Timeline-control Widget Tests
-->
<html>
  <head>
    <title>jQuery Custom Widget Tests</title>
    <link rel="icon" href="favicon.ico" sizes="16x16 32x32 48x48 64x64 96x96 128x128" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="index.css">
    <link rel="stylesheet" type="text/css" href="timeline-control.css">
    <script src=" https://code.jquery.com/jquery-3.3.1.min.js"></script><!-- todo: create bundle -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script><!-- todo: create bundle -->
    <script src="https://d3js.org/d3.v5.min.js"></script><!-- ToDo: create bundle -->
    <script src="timeline.1.js"></script>
    <script src="barView.js"></script>
    <script src="barViewConstraint.js"></script>
    <script>

      const MIN_DATA_VALUE = 10;
      const MAX_DATA_VALUE = 1000;

      let testDataN = [];

      /**
       * Create a random data set with a size of 'sz' and values between 'min' and 'max'.
       *
       * sz {integer} Number of values
       * range {object} Range of values, {"min":int, "max": int}
       */
      function makeRandomDataSet(sz, range) {
        let i, data = [];

        for (i = 0; i < sz; i +=1) {
          data[i] = {
            'key': Math.round(Math.random() * (range.max - range.min) + range.min),
            'value': i
          };
        }

        return data;
      }

      // An empty data set is an error/invalid
      let testData0 = [];

      let testData1 = [
        {'key':-1, 'value': 1}
      ];

      let testData2 = [
        {'key':0, 'value': 0},
        {'key':1, 'value': 1}
      ];

      let testData3 = [
        {'key':0, 'value': 0},
        [
          {'key':1, 'value': 1},
          {'key':1, 'value': 2}
        ]
      ];

      let testData5 = [
        {'key':1, 'value': 1},
        {'key':2, 'value': 2},
        {'key':3, 'value': 3},
        {'key':4, 'value': 4},
        {'key':5, 'value': 5}
      ]

      let testData10 = [
        {'key':1, 'value': 1},
        {'key':2, 'value': 2},
        {'key':3, 'value': 3},
        {'key':3, 'value': 4},
        {'key':9, 'value': 5},
        {'key':8, 'value': 6},
        {'key':7, 'value': 7},
        {'key':6, 'value': 8},
        {'key':5, 'value': 9},
        {'key':3, 'value': 10}
      ]

      let dataSets =[
        testData0,
        testData1,
        testData2,
        testData3,
        testData5,
        testData10
      ]

      /*
       * On load handler
       *
       * @returns {undefined}
       */
      window.onload = function () {
        console.log("OnLoad");
      };

      /*
       * Document ready handler
       *
       * @type type
       */
      $(document).ready(function () {
        console.log("documentReady");

        //
        // setup the data contraint view
        //

        // alternate widget initialization syntax
        // var bar = $.custom.progressbar({}, $("<div></div>").appendTo("body"));

        let widgetElement1 = $("#widgetElement1");

        // construct a timeline widget in the widgetElement2 element. We pass
        // in a custom handler for the atstart' custom event.
        widgetElement1.timeline({
          // the widget defaults to using the widgetElement height, which is not set,
          // so provide an explict height.
          height: '48px',
          data: testData10
        });

        // Alternate way of calling widget methods by calling object and passing in func name
        //console.log("Initial value: " + widgetElement.timeline("value"));

        let dataConstraint = widgetElement1.data("custom-timeline");

        // Notes:
        // 1) Custom handlers are called before the default.
        // 2) Returning false or using stopImmediatePropagation(), stopPropagation()
        // and preventDefault() does not seem to stop the default handler from firing?
        // 3) Note the closure. hander doesn't have a wy to pass in a widget context?
        widgetElement1.bind("timelinechange", function (event, data) {
          let strValue, keys;

          if ($.type(data) === "array") {
            strValue = "Array with " + data.keys.length + " length.";
          } else if ($.type(data) === "object") {
            keys = Object.keys(data);
            strValue = "Object with " + keys.length + " keys. '" + keys[0] + "', ...";
          } else {
            strValue = data.value;
          }

          console.log("User defined change handler. Key is '" + data.key  + "', Value is " + strValue);
        });


        //
        // setup the primary data view
        //

        let widgetElement2 = $("#widgetElement2");


        widgetElement2.barView({
          height: '48px',
          data: testData10
        });

        let myBarView = widgetElement2.data("custom-barView");

        //
        // setup the primary data view constraint
        //

        let widgetElement3 = $("#widgetElement3");

        widgetElement3.barViewConstraint({
          height: '48px',
          data: testData10
        });

        let myBarViewConstraint = widgetElement3.data("custom-barViewConstraint");

        //
        // Setup the load data UI
        //
        // Note: the click event also triggers on 'keypress enter'
        //
        $('#bGo').on('click', function (event) {
          let idx, testData, size,
            selectValue = $('#dataSet').val();

          if (selectValue === "N") {
            size = Math.round(Math.random() * (100 - 10) + 10);
            testData = makeRandomDataSet(size, {"min":MIN_DATA_VALUE, "max":MAX_DATA_VALUE});
          } else {
            idx = parseInt(selectValue);
            testData = dataSets[idx];
          }

          try {
            dataConstraint.option('data', testData);
          } catch (e) {
            alert (e.message);
          }

          try {
            myBarView.option('data', testData);
          } catch (e) {
            alert (e.message);
          }

          try {
            myBarViewConstraint.option('data', testData);
          } catch (e) {
            alert (e.message);
          }

        });

      });

  </script>
  </head>
  <body>
    <div class="content">
      <div class="title-block">
        <h1>Timeline Control Widget Test</h1>
      </div>

      <div id="widgetElement1" class="widgetElement full"></div>
      <div id="widgetElement2" class="widgetElement full"></div>
      <div id="widgetElement3" class="widgetElement full"></div>

      <div class="test-selector-container">
        <select id="dataSet">
          <option value="0">Test Data #0</option>
          <option value="1">Test Data #1</option>
          <option value="2">Test Data #2</option>
          <option value="3">Test Data #3</option>
          <option value="4">Test Data #5</option>
          <option value="5" selected>Test Data #10</option>
          <option value="N">Test Data #N</option>
        </select>
        <button id="bGo">Load Data</button>
      </div>
    </div><!-- content -->

    <div id="debugConsole"></div>

  </body>
</html>
